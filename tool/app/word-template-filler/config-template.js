// 配置模板生成器
// 生成Excel配置模板供用户下载

function downloadConfigTemplate() {
    // Sheet1: 字段配置（空白模板）
    const fieldConfigData = [
        ['字段名', '显示名称', '类型', '选项', '默认值', '必填', '提示', '格式', '子表', '行数'],
        ['', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', '']
    ];

    // Sheet2: 使用说明
    const helpData = [
        ['=== 字段类型说明 ===', '', '', ''],
        ['类型', '说明', 'Word模板写法', '备注'],
        ['文本', '单行文本输入框', '{字段名}', '最常用的类型'],
        ['多行文本', '多行文本输入框', '{字段名}', '适合长内容，可设置行数'],
        ['日期', '日期选择器', '{字段名}', '可设置输出格式'],
        ['是否', '是/否两个选项', '{字段名Pass} 是  {字段名Fail} 否', '选"是"时Pass=☑，选"否"时Fail=☑'],
        ['单选', '多个选项选一个', '{字段名_选项值}', '每个选项一个占位符，选中=☑，未选=□'],
        ['多选', '可选多个选项', '{字段名_选项值}', '每个选项一个占位符，选中=☑，未选=□'],
        ['列表', '可添加多行数据', '{#字段名}...{/字段名}', '需要创建子表定义子字段'],
        ['', '', '', ''],
        ['=== 列名说明 ===', '', '', ''],
        ['列名', '是否必填', '说明', '示例'],
        ['字段名', '必填', '对应Word模板中的占位符，建议用英文', 'name, date, content'],
        ['显示名称', '必填', '表单中显示的标签文字', '姓名, 日期, 内容描述'],
        ['类型', '必填', '见上方类型说明', '文本, 日期, 单选'],
        ['选项', '单选/多选必填', '用英文逗号分隔各选项', '优秀,良好,合格,不合格'],
        ['默认值', '可选', '表单的默认值（是否类型填"是"或"true"）', ''],
        ['必填', '可选', '填"是"表示必填', '是'],
        ['提示', '可选', '输入框的提示文字', '请输入姓名'],
        ['格式', '可选', '日期的输出格式', 'YYYY年MM月DD日'],
        ['子表', '列表类型必填', '子字段所在的工作表名称', '订单明细'],
        ['行数', '可选', '多行文本的行数，默认3', '5'],
        ['', '', '', ''],
        ['=== 是否类型的Word写法 ===', '', '', ''],
        ['假设字段名是status', '', '', ''],
        ['Word模板中这样写：{statusPass} 通过  {statusFail} 不通过', '', '', ''],
        ['用户选"是"时：☑ 通过  □ 不通过', '', '', ''],
        ['用户选"否"时：□ 通过  ☑ 不通过', '', '', ''],
        ['', '', '', ''],
        ['=== 单选/多选的Word写法 ===', '', '', ''],
        ['假设字段名是level，选项是"优秀,良好,合格"', '', '', ''],
        ['Word模板中这样写：', '', '', ''],
        ['{level_优秀} 优秀  {level_良好} 良好  {level_合格} 合格', '', '', ''],
        ['选中哪个，哪个就显示☑，其他显示□', '', '', '']
    ];

    // Sheet3: 完整示例 - Helldivers 2 战斗报告
    const exampleMainData = [
        ['=== 这是一个完整的示例：Helldivers 2 战斗报告 ===', '', '', '', '', '', '', '', '', ''],
        ['下面的内容你需要复制到"字段配置"工作表中', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['字段名', '显示名称', '类型', '选项', '默认值', '必填', '提示', '格式', '子表', '行数'],
        ['playerName', 'Helldiver代号', '文本', '', '', '是', '输入你的游戏ID', '', '', ''],
        ['missionDate', '任务日期', '日期', '', '', '是', '', 'YYYY年MM月DD日', '', ''],
        ['planet', '作战星球', '单选', '天狼星,马拉维隆,克里克,艾斯塔瓦隆,范戈尔', '', '是', '', '', '', ''],
        ['enemy', '敌人类型', '单选', '终结者机器人,虫群,光能者', '', '是', '', '', '', ''],
        ['difficulty', '难度等级', '单选', '简单,中等,挑战,极限,自杀,地狱潜兵', '挑战', '是', '', '', '', ''],
        ['missionType', '任务类型', '多选', '歼灭,护送,防守,回收,暗杀', '', '是', '', '', '', ''],
        ['teamSize', '小队人数', '文本', '', '4', '是', '1-4人', '', '', ''],
        ['result', '任务结果', '是否', '', 'true', '是', '', '', '', ''],
        ['kills', '击杀数', '文本', '', '', '', '个人击杀数', '', '', ''],
        ['deaths', '阵亡次数', '文本', '', '', '', '', '', '', ''],
        ['samples', '获得样本', '文本', '', '', '', '普通/稀有/超级样本数量', '', '', ''],
        ['review', '战斗总结', '多行文本', '', '', '', '记录本次任务的精彩瞬间或惨痛教训', '', '', '5'],
        ['', '', '', '', '', '', '', '', '', ''],
        ['=== 对应的Word模板内容 ===', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['【绝地潜兵战斗报告】', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['Helldiver代号：{playerName}', '', '', '', '', '', '', '', '', ''],
        ['任务日期：{missionDate}', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['【作战信息】', '', '', '', '', '', '', '', '', ''],
        ['作战星球：{planet}', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['敌人类型：', '', '', '', '', '', '', '', '', ''],
        ['{enemy_终结者机器人} 终结者机器人  {enemy_虫群} 虫群  {enemy_光能者} 光能者', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['难度等级：{difficulty}', '', '', '', '', '', '', '', '', ''],
        ['小队人数：{teamSize}人', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['任务类型：', '', '', '', '', '', '', '', '', ''],
        ['{missionType_歼灭} 歼灭  {missionType_护送} 护送  {missionType_防守} 防守', '', '', '', '', '', '', '', '', ''],
        ['{missionType_回收} 回收  {missionType_暗杀} 暗杀', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['【战斗结果】', '', '', '', '', '', '', '', '', ''],
        ['任务状态：{resultPass} 成功撤离  {resultFail} 全员阵亡', '', '', '', '', '', '', '', '', ''],
        ['击杀数：{kills}    阵亡次数：{deaths}', '', '', '', '', '', '', '', '', ''],
        ['获得样本：{samples}', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['【战斗总结】', '', '', '', '', '', '', '', '', ''],
        ['{review}', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['为了超级地球！为了民主！', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['=== 填写效果说明 ===', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['用户在网页表单中填写：', '', '', '', '', '', '', '', '', ''],
        ['- Helldiver代号：DemocracyFan2077', '', '', '', '', '', '', '', '', ''],
        ['- 任务日期：2025-01-15', '', '', '', '', '', '', '', '', ''],
        ['- 作战星球：选择"马拉维隆"', '', '', '', '', '', '', '', '', ''],
        ['- 敌人类型：选择"终结者机器人"', '', '', '', '', '', '', '', '', ''],
        ['- 难度等级：选择"地狱潜兵"', '', '', '', '', '', '', '', '', ''],
        ['- 任务类型：勾选"歼灭"和"暗杀"', '', '', '', '', '', '', '', '', ''],
        ['- 小队人数：4', '', '', '', '', '', '', '', '', ''],
        ['- 任务结果：选择"是"（成功）', '', '', '', '', '', '', '', '', ''],
        ['- 击杀数：328', '', '', '', '', '', '', '', '', ''],
        ['- 阵亡次数：12', '', '', '', '', '', '', '', '', ''],
        ['- 获得样本：普通45/稀有12/超级3', '', '', '', '', '', '', '', '', ''],
        ['- 战斗总结：队友500kg炸弹精准命中我方小队...', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['导出的Word文档中显示：', '', '', '', '', '', '', '', '', ''],
        ['- {playerName} → DemocracyFan2077', '', '', '', '', '', '', '', '', ''],
        ['- {missionDate} → 2025年01月15日', '', '', '', '', '', '', '', '', ''],
        ['- {enemy_终结者机器人} → ☑，其他敌人 → □', '', '', '', '', '', '', '', '', ''],
        ['- {missionType_歼灭} → ☑，{missionType_暗杀} → ☑，其他 → □', '', '', '', '', '', '', '', '', ''],
        ['- {resultPass} → ☑，{resultFail} → □', '', '', '', '', '', '', '', '', '']
    ];

    // Sheet4: 列表类型示例 - GTA5抢劫计划
    const exampleLoopData = [
        ['=== 这是列表类型的示例：GTA5 抢劫行动计划书 ===', '', '', '', '', '', '', '', '', ''],
        ['列表类型用于需要填写多行数据的场景，比如队员分工', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['【主表配置】复制到"字段配置"工作表', '', '', '', '', '', '', '', '', ''],
        ['字段名', '显示名称', '类型', '选项', '默认值', '必填', '提示', '格式', '子表', '行数'],
        ['heistName', '行动代号', '文本', '', '', '是', '给这次行动起个霸气的名字', '', '', ''],
        ['heistDate', '行动日期', '日期', '', '', '是', '', 'YYYY年MM月DD日', '', ''],
        ['target', '目标', '单选', '太平洋标准银行,人道实验室,末日将至,佩里科岛,钻石赌场', '', '是', '', '', '', ''],
        ['approach', '进攻方式', '单选', '潜入,正面强攻,诡计多端', '', '是', '', '', '', ''],
        ['crew', '队员分工', '列表', '', '', '是', '', '', '队员配置', ''],
        ['totalCut', '预计收益', '文本', '', '', '', '预计总收益（美元）', '', '', ''],
        ['plan', '行动计划', '多行文本', '', '', '', '详细描述行动步骤', '', '', '6'],
        ['escape', '撤离路线', '文本', '', '', '是', '撤离时使用的载具和路线', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['【子表配置】需要新建一个名为"队员配置"的工作表，内容如下：', '', '', '', '', '', '', '', '', ''],
        ['字段名', '显示名称', '类型', '选项', '默认值', '', '', '', '', ''],
        ['memberName', '队员ID', '文本', '', '', '', '', '', '', ''],
        ['role', '职责', '文本', '', '', '', '', '', '', ''],
        ['cut', '分成比例', '文本', '', '', '', '', '', '', ''],
        ['weapon', '装备', '文本', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['【Word模板写法】', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['【GTA5 抢劫行动计划书】', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['行动代号：{heistName}', '', '', '', '', '', '', '', '', ''],
        ['行动日期：{heistDate}', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['【目标信息】', '', '', '', '', '', '', '', '', ''],
        ['{target_太平洋标准银行} 太平洋标准银行  {target_人道实验室} 人道实验室', '', '', '', '', '', '', '', '', ''],
        ['{target_末日将至} 末日将至  {target_佩里科岛} 佩里科岛  {target_钻石赌场} 钻石赌场', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['进攻方式：{approach}', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['【队员分工】', '', '', '', '', '', '', '', '', ''],
        ['{#crew}', '', '', '', '', '', '', '', '', ''],
        ['队员：{memberName} | 职责：{role} | 分成：{cut} | 装备：{weapon}', '', '', '', '', '', '', '', '', ''],
        ['{/crew}', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['预计收益：${totalCut}', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['【行动计划】', '', '', '', '', '', '', '', '', ''],
        ['{plan}', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['撤离路线：{escape}', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['【说明】', '', '', '', '', '', '', '', '', ''],
        ['{#crew} 和 {/crew} 之间的内容会根据队员数量重复生成', '', '', '', '', '', '', '', '', ''],
        ['比如你添加了4个队员，导出时就会生成4行队员信息', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['【填写示例】', '', '', '', '', '', '', '', '', ''],
        ['假设你在表单里添加了3个队员：', '', '', '', '', '', '', '', '', ''],
        ['队员1：xXx_Killer_xXx | 黑客 | 20% | 突击步枪', '', '', '', '', '', '', '', '', ''],
        ['队员2：NoobMaster69 | 驾驶员 | 20% | 冲锋枪', '', '', '', '', '', '', '', '', ''],
        ['队员3：你自己 | 队长 | 60% | 重型狙击枪', '', '', '', '', '', '', '', '', ''],
        ['', '', '', '', '', '', '', '', '', ''],
        ['导出的Word里就会显示3行队员信息', '', '', '', '', '', '', '', '', '']
    ];

    // 创建工作簿
    const wb = XLSX.utils.book_new();

    // Sheet1: 字段配置
    const ws1 = XLSX.utils.aoa_to_sheet(fieldConfigData);
    ws1['!cols'] = [
        { wch: 15 }, { wch: 15 }, { wch: 10 }, { wch: 30 },
        { wch: 10 }, { wch: 6 }, { wch: 20 }, { wch: 18 }, { wch: 12 }, { wch: 6 }
    ];
    XLSX.utils.book_append_sheet(wb, ws1, '字段配置');

    // Sheet2: 使用说明
    const ws2 = XLSX.utils.aoa_to_sheet(helpData);
    ws2['!cols'] = [{ wch: 50 }, { wch: 15 }, { wch: 50 }, { wch: 30 }];
    XLSX.utils.book_append_sheet(wb, ws2, '使用说明');

    // Sheet3: 示例-请假申请
    const ws3 = XLSX.utils.aoa_to_sheet(exampleMainData);
    ws3['!cols'] = [
        { wch: 60 }, { wch: 15 }, { wch: 12 }, { wch: 35 },
        { wch: 10 }, { wch: 6 }, { wch: 25 }, { wch: 18 }, { wch: 12 }, { wch: 6 }
    ];
    XLSX.utils.book_append_sheet(wb, ws3, '示例-Helldivers2');

    // Sheet4: 示例-列表类型
    const ws4 = XLSX.utils.aoa_to_sheet(exampleLoopData);
    ws4['!cols'] = [
        { wch: 60 }, { wch: 15 }, { wch: 12 }, { wch: 35 },
        { wch: 10 }, { wch: 6 }, { wch: 25 }, { wch: 18 }, { wch: 12 }, { wch: 6 }
    ];
    XLSX.utils.book_append_sheet(wb, ws4, '示例-GTA5抢劫');

    // 导出文件
    XLSX.writeFile(wb, 'Word模板配置.xlsx');
}


// 下载示例文件（打包成zip）
async function downloadSample() {
    try {
        const zip = new JSZip();
        
        // 加载示例文件
        const [excelResp, docxResp] = await Promise.all([
            fetch('../../../template/word-filler-sample/excel.xlsx'),
            fetch('../../../template/word-filler-sample/document.docx')
        ]);
        
        if (!excelResp.ok || !docxResp.ok) {
            throw new Error('示例文件加载失败');
        }
        
        const excelData = await excelResp.arrayBuffer();
        const docxData = await docxResp.arrayBuffer();
        
        zip.file('示例配置.xlsx', excelData);
        zip.file('示例模板.docx', docxData);
        
        const blob = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Word模板填充器示例.zip';
        a.click();
        URL.revokeObjectURL(url);
    } catch (e) {
        console.error(e);
        alert('下载失败: ' + e.message);
    }
}
